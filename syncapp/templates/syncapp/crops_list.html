{% extends "syncapp/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid my-4">
  <div class="row">

    <!-- Sidebar Tabs -->
    <nav class="col-md-3 col-lg-2 mb-3 mb-md-0 d-md-block bg-light sidebar shadow-sm rounded p-3">
      <h5 class="text-center mb-3">
        <img src="{% static 'logo.png' %}" alt="Logo" style="height:3em; max-height:50px; width:auto; margin-right:0.5em;">
        Commodity History
      </h5>
      <ul class="nav flex-column nav-pills gap-2" id="cropsMenu">
        <li class="nav-item">
          <a class="nav-link {% if has_crops and not is_edit %}active{% endif %}" href="#listCrops" data-bs-toggle="tab">üåæ Purchased Commodity</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if not has_crops or is_edit %}active{% endif %}" href="#formCrops" data-bs-toggle="tab">‚ûï Add Crop</a>
                  </li>
        <li class="nav-item">
          <a class="nav-link" href="#mapCrops" data-bs-toggle="tab">üó∫Ô∏è View on Map</a>
        </li>
      </ul>
    </nav>

    <!-- Right Content -->
    <main class="col-md-9 col-lg-10">
      <div class="tab-content w-100 mx-auto" style="max-width: 1000px; border:1px solid #ddd; border-radius:10px; padding:20px; background:#fff;">

        <!-- Purchased Commodity -->
          <div class="tab-pane fade {% if has_crops and not is_edit %}show active{% endif %}" id="listCrops">          <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white text-center">
              
              {% if user.is_authenticated and user.job == 'farmer' %}
              üõí Sold Commodities
            {% else %}
              üåæ Purchased Commodities
            {% endif %}
            </div>
            <div class="card-body p-0">
              {% if crops %}
              <div class="table-responsive w-100">
                <table class="table table-bordered table-striped table-hover text-center mx-auto">
                  <thead>
                    <tr>
                      <th>#</th><th>Commodity</th><th>Price</th><th>Quantity</th><th>Unit</th>
                      <th>Image</th><th>Date</th><th>Latitude</th><th>Longitude</th><th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for crop in crops %}
                    <tr class="{% cycle 'table-light' 'table-secondary' %}">
                      <td>{{ forloop.counter }}</td>
                      <td>{{ crop.commodity }}</td>
                      <td>{% if crop.buyingprice %}{{ crop.buyingprice }}
                        {% elif crop.sellingprice %}{{ crop.sellingprice }}
                        {% else %}-{% endif %}</td>
                      <td>{% if  crop.quantitybought %}{{ crop.quantitybought }}
                        {% elif crop.quantitysold %}{{ crop.quantitysold }}
                        {% else %}-{% endif %}</td>
                      </td>
                      <td>{{ crop.unit|default:"-" }}</td>
                      <td>
                        {% if crop.image %}
                        <img src="{{ crop.image.url }}" alt="Image" style="width:80px; height:60px; object-fit:cover; border-radius:6px;">
                        {% else %}No Image{% endif %}
                      </td>
                      <td>{{ crop.date|date:"d M Y, H:i" }}</td>
                      <td>{{ crop.latitude }}</td>
                      <td>{{ crop.longitude }}</td>
                      <td>
                        <a href="?edit={{ crop.id }}" class="btn btn-sm btn-primary" title="Edit"><i class="bi bi-pencil-square"></i></a>
                        <a href="{% url 'delete_crop' crop.id %}" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure?')"><i class="bi bi-trash"></i></a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <p class="text-center p-3 text-muted">No crops added yet.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Add / Update Crop Form -->
        <div class="tab-pane fade {% if not has_crops or is_edit  %}show active{% endif %}" id="formCrops">
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white" id="formHeader">
              {% if is_edit %}‚úèÔ∏è Update Crop{% else %}‚ûï Add Crop{% endif %}
            </div>
            <div class="card-body">
              <form id="cropForm" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="row g-3">
                  {% for field in form %}
                  <div class="col-12 col-md-6">
                    <div class="form-group">
                      {{ field.label_tag }} {{ field }}
                      {% if field.errors %}
                      <div class="text-danger small">{{ field.errors|join:", " }}</div>
                      {% endif %}
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                  <button type="submit" class="btn btn-success" id="submitBtn">{% if is_edit %}Update{% else %}Add{% endif %}</button>
                  {% if is_edit %}
                  <a href="{% url 'crops_list' %}" class="btn btn-secondary">Cancel</a>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Map Section -->
        <div class="tab-pane fade" id="mapCrops">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">üó∫Ô∏è Crops Map</div>
            <div class="card-body">
              <div id="map" style="height:500px; width:100%; border-radius:8px;"></div>
            </div>
          </div>
        </div>

      </div>
    </main>

  </div>
</div>

<!-- JS and Leaflet -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.js"></script>

<!-- Bootstrap 5 JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {

// ---------------- Handle Tabs ----------------
// Determine if Add Crop tab should be shown
var showFormTab = {% if not has_crops or is_edit %}true{% else %}false{% endif %};

// Get all tab links
var tabLinks = document.querySelectorAll('#cropsMenu .nav-link');

if(showFormTab){
    // Show Add Crop tab
    var formTabEl = document.querySelector('#cropsMenu a[href="#formCrops"]');
    if(formTabEl){
        var tab = new bootstrap.Tab(formTabEl);
        tab.show();
    }
} else {
    // Show Purchased Commodity tab if user already has crops
    var listTabEl = document.querySelector('#cropsMenu a[href="#listCrops"]');
    if(listTabEl){
        var tab = new bootstrap.Tab(listTabEl);
        tab.show();
    }
}

// ---------------- Initialize Map ----------------
var mapDiv = document.getElementById("map");
if(mapDiv){
    var map = L.map("map",{zoomControl:true});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:14,minZoom:2}).addTo(map);
    // Optional Google satellite overlay
    L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{subdomains:['0','1','2','3'], maxZoom:21}).addTo(map);
    map.setView([20.5937,78.9629],5);

    var crops = {{ crops_json|safe }};
    if(crops.length){
        var bounds=[];
        crops.forEach(function(c,i){
            var offset=0.00005;
            var lat=c.lat+i*offset, lng=c.lng+i*offset;
            var marker=L.marker([lat,lng]).addTo(map);
            var img = c.image_url? '<br><img src="'+c.image_url+'" style="width:100px;height:80px;object-fit:cover;border-radius:5px;">' : '';
            marker.bindPopup("<b>"+c.commodity+"</b><br>Price:"+c.price+"<br>Qty:"+(c.quantity||'-')+" "+c.unit+"<br>Date:"+(c.date||'-')+img);
            bounds.push([lat,lng]);
        });
        map.fitBounds(bounds);
    }
}

});

</script>
{% endblock %}
