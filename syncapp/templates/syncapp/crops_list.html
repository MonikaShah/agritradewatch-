{% extends "syncapp/base.html" %}
{% load static %}

{% block content %}
<div class="container-fluid my-4">
  <div class="row">

    <!-- Left Sidebar -->
    <nav class="col-md-3 col-lg-2 mb-3 mb-md-0 d-md-block bg-light sidebar shadow-sm rounded p-3">
      <h5 class="text-center mb-3">üå± Crops Menu</h5>
      <ul class="nav flex-column nav-pills gap-2" id="cropsMenu">
        <li class="nav-item">
          <a class="nav-link {% if not is_edit and not show_map %}active{% endif %}" href="#listCrops" data-bs-toggle="tab">
            üåæ List Crops
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if is_edit %}active{% endif %}" href="#formCrops" data-bs-toggle="tab">
            {% if is_edit %}‚úèÔ∏è Update Crop{% else %}‚ûï Add Crop{% endif %}
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if show_map %}active{% endif %}" href="#mapCrops" data-bs-toggle="tab">
            üó∫Ô∏è View on Map
          </a>
        </li>
      </ul>
    </nav>

    <!-- Right Content -->
    <main class="col-md-9 col-lg-10">
      <div class="tab-content w-100 mx-auto" 
           style="max-width: 1000px; border:1px solid #ddd; border-radius: 10px; padding:20px; background:#fff;">
    
        <!-- Crop List (default) -->
        <div class="tab-pane fade {% if not is_edit and not show_map %}show active{% endif %}" id="listCrops">
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white text-center">üåæ Your Crops</div>
            <div class="card-body p-0">
              {% if crops %}
              <div class="table-responsive w-100">
                <table class="table table-bordered table-striped table-hover text-center mx-auto">
                  <thead>
                    <tr>
                      <th>#</th>
                      <th>Commodity</th>
                      <th>Price</th>
                      <th>Quantity</th>
                      <th>Unit</th>
                      <th>Date</th>
                      <th>Latitude</th>
                      <th>Longitude</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for crop in crops %}
                    <tr class="{% cycle 'table-light' 'table-secondary' %}">
                      <td>{{ forloop.counter }}</td>
                      <td>{{ crop.commodity }}</td>
                      <td>{{ crop.buyingprice }}</td>
                      <td>{{ crop.quantitybought|default:"-" }}</td>
                      <td>{{ crop.unit|default:"-" }}</td>
                      <td>{{ crop.date|date:"Y-m-d H:i" }}</td>
                      <td>{{ crop.latitude }}</td>
                      <td>{{ crop.longitude }}</td>
                      <td class="d-flex gap-1 justify-content-center flex-wrap">
                        <a href="?edit={{ crop.id }}" class="btn btn-sm btn-primary" title="Edit">
                          <i class="bi bi-pencil-square"></i>
                        </a>
                        <a href="{% url 'delete_crop' crop.id %}" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure?')">
                          <i class="bi bi-trash"></i>
                        </a>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
                <p class="text-center p-3 text-muted">No crops added yet.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Crop Form -->
        <div class="tab-pane fade {% if is_edit %}show active{% endif %}" id="formCrops">
          <div class="card mb-4 shadow-sm">
            <div class="card-header bg-success text-white">
              {% if is_edit %} ‚úèÔ∏è Update Crop {% else %} ‚ûï Add Crop {% endif %}
            </div>
            <div class="card-body">
              <form method="POST">
                {% csrf_token %}
                <div class="row g-3">
                  {% for field in form %}
                    <div class="col-12 col-md-6">
                      <div class="form-group">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.errors %}
                          <div class="text-danger small">{{ field.errors|join:", " }}</div>
                        {% endif %}
                      </div>
                    </div>
                  {% endfor %}
                </div>
                <div class="mt-3 d-flex gap-2 flex-wrap">
                  <button type="submit" class="btn btn-success">
                    {% if is_edit %}Update{% else %}Add{% endif %}
                  </button>
                  {% if is_edit %}
                    <a href="{% url 'crops_list' %}" class="btn btn-secondary">Cancel</a>
                  {% endif %}
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Map Section -->
        <div class="tab-pane fade {% if show_map %}show active{% endif %}" id="mapCrops">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">üó∫Ô∏è Crops Map</div>
            <div class="card-body">
              <div id="map" style="height:500px; width:100%; border-radius:8px;"></div>
            </div>
          </div>
        </div>
    
      </div>
    </main>
    
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    var mapDiv = document.getElementById("map");
    if (!mapDiv) return;
  
    // Initialize map
    var map = L.map("map", { zoomControl: true });
    
    // OSM fallback layer
    var osmLayer = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '&copy; OpenStreetMap contributors', maxZoom: 14, minZoom: 2 }
    );
  
    // Google Satellite tiles
    var googleSat = L.tileLayer(
      'https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
      { attribution: '&copy; Google', subdomains: ['0','1','2','3'], maxZoom: 21, minZoom: 2, detectRetina: true }
    );
  
    // Add both layers to control
    var baseLayers = {
      "OSM": osmLayer,
      "Google Satellite": googleSat
    };
    L.control.layers(baseLayers).addTo(map);
  
    // Set default view and add OSM by default
    map.setView([20.5937, 78.9629], 5);
    osmLayer.addTo(map);
  
    // Add crop markers
    var crops = [
      {% for crop in crops %}
        {% if crop.latitude and crop.longitude %}
          {
            lat: {{ crop.latitude }},
            lng: {{ crop.longitude }},
            commodity: "{{ crop.commodity|escapejs }}",
            price: "{{ crop.buyingprice|default:''|escapejs }}",
            quantity: "{{ crop.quantitybought|default:''|escapejs }}",
            unit: "{{ crop.unit|default:''|escapejs }}"
          }{% if not forloop.last %},{% endif %}
        {% endif %}
      {% endfor %}
    ];
    if (crops.length > 0) {
      var bounds = [];
      crops.forEach(function(crop) {
        var marker = L.marker([crop.lat, crop.lng]).addTo(map);
        marker.bindPopup(
          "<b>" + crop.commodity + "</b><br/>" +
          "Price: " + crop.price + "<br/>" +
          "Qty: " + (crop.quantity || '-') + " " + crop.unit
        );
        bounds.push([crop.lat, crop.lng]);
      });
      map.fitBounds(bounds);
    }
  
    // Fix map display when tab is shown
    var mapTab = document.querySelector('a[href="#mapCrops"]');
    if (mapTab) {
      mapTab.addEventListener('shown.bs.tab', function() {
        map.invalidateSize(); // redraw map
        // Optionally auto-switch to Google Satellite
        if (!map.hasLayer(googleSat)) {
          map.addLayer(googleSat);
        }
      });
    }
  });
  </script>
  
  
{% endblock %}
