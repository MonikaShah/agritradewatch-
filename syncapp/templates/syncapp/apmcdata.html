{% extends 'syncapp/base.html' %}
{% load static %}

{% block title %}Wholesale Market Prices{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
  /* FILTER BAR */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-end;
    margin-bottom: 15px;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .filter-bar .form-group {
    flex: 1 1 180px;
    min-width: 160px;
  }

  /* MAIN PANEL LAYOUT */
  .main-content {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .map-panel { flex:3; height:520px; background:#fff; border:1px solid #e0e0e0; border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-panel { flex:7; height:520px; background:#fff; border:1px solid #e0e0e0; border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
  
  #map {
    flex: 1;
    width: 100%;
    border-radius: 15px;
  }
  .chart-panel h5 {
    background: linear-gradient(90deg, #007bff, #00b4d8);
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 10px;
    border-radius: 15px 15px 0 0;
    font-size: 1rem;
  }
  .chart-panel canvas {
    flex: 1;
    padding: 10px;
  }

  @media (max-width: 768px) {
    .main-content {
      flex-direction: column;
    }
    .map-panel {
      width: 100%;
      height: 400px;
    }
  }

  .map-panel {
    position: relative;
  }

  #mapOverlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.5); /* lighter overlay */
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 1.3rem;
    font-weight: 600;
    color: #222;
    backdrop-filter: blur(3px); /* subtle glass effect */
    z-index: 500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    pointer-events: none; /* allows map panning/zooming */
  }.map-chart-row {
  display: flex;
  gap: 1rem;
  align-items: stretch;
}
.map-chart-row {
  display: flex;
  gap: 1rem;
  align-items: stretch;
}

.map-panel {
  flex: 0 0 30%;
  height: 700px; /* ðŸ”¹ increase total map+chart panel height */
  border-radius: 15px;
  overflow: hidden;
}
.map-chart-row {
  display: flex;
  justify-content: space-between;
  align-items: stretch;
  gap: 1rem;
}

/* Map panel */
.map-panel {
  flex: 0 0 30%;
  height: 75vh; /* consistent height relative to screen */
  border-radius: 15px;
  overflow: hidden;
}

/* Chart panel */
.chart-panel {
  flex: 0 0 70%;
  height: 75vh;
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 15px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
}

/* Title */
.chart-title {
  font-weight: 600;
  font-size: 1rem;
  padding: 10px;
  background: linear-gradient(90deg, #007bff, #00b4d8);
  color: white;
  margin: 0;
  border-top-left-radius: 15px;
  border-top-right-radius: 15px;
  text-align: center;
}

/* Chart Container */
.chartContainer {
  flex: 1;
  position: relative;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 10px;
  min-height: 400px;
}

.chartContainer canvas {
  width: 100% !important;
  height: 100% !important;
  border: 2px solid #007bff; /* clear border visible */
  border-radius: 12px;
  box-sizing: border-box;
  display: block;
}

/* Footer */
.chart-footer {
  padding: 8px 12px;
  border-top: 1px solid #eee;
  background: #fafafa;
  font-size: 0.85rem;
  color: #555;
}

/* Responsive */
@media (max-width: 768px) {
  .map-chart-row {
    flex-direction: column;
  }

  .map-panel, .chart-panel {
    width: 100%;
    height: 50vh; /* adjusts well on mobile */
  }
}

</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3 text-primary">Wholesale Market Prices</h2>
  <div id="dynamicAlert" class="alert alert-warning alert-dismissible fade show" style="display:none;"></div>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <div class="form-group">
      <label for="commoditySelect" class="form-label">Commodity</label>
      <select id="commoditySelect" class="form-select w-100">
        <option value="">All Commodities</option>
        {% for item in commodities %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="lineStartDate" class="form-label">Start Date</label>
      <input type="date" id="lineStartDate" class="form-control w-100"
             value="{{ today|date:'Y-m-d' }}" min="2014-01-01" max="{{ today|date:'Y-m-d' }}">
    </div>

    <div class="form-group">
      <label for="lineEndDate" class="form-label">End Date</label>
      <input type="date" id="lineEndDate" class="form-control w-100"
             value="{{ today|date:'Y-m-d' }}" min="2025-08-11" max="{{ today|date:'Y-m-d' }}">
    </div>

    <div class="form-group">
      <label for="apmcSelect" class="form-label">APMC</label>
      <select id="apmcSelect" class="form-select w-100" disabled>
        <option value="">Select APMC</option>
      </select>
    </div>

    <div class="form-group">
      <button id="submitBtn" class="btn btn-primary w-100">Show Prices</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="map-chart-row d-flex">
    <div class="map-panel" id="mapContainer">
      <div id="map"></div>
       <div id="mapOverlay" style="display:none;"></div>
  </div>

  <div class="chart-panel">
    <h5 class="chart-title">AgmarkNet Prices Trend</h5>  
    <div id="chartContainer" class="chartContainer" style="height: 100%; min-height: 500px;">
      <div id="loading-spinner" class="text-center my-3" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Processing data, please wait...</p>
      </div>
  
      <canvas id="agmarkLineChart" ></canvas>
    </div>
  
    <div class="chart-footer">
      <p class="chart-tip">ðŸ’¡ Tip: Scroll to zoom, drag (or Ctrl + drag) to pan.</p>
      <p class="chart-source">Data Source: <a href="https://data.gov.in" target="_blank">data.gov.in</a></p>
    </div>
  </div>
  
      
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const commoditySelect = document.getElementById("commoditySelect");
  const apmcSelect = document.getElementById("apmcSelect");
  const lineStartDate = document.getElementById("lineStartDate");
  const lineEndDate = document.getElementById("lineEndDate");
  const submitBtn = document.getElementById("submitBtn");
  const dynamicAlert = document.getElementById("dynamicAlert");

  let agmarkLineChart = null;
  let map, markerLayer;
 
  Chart.register(ChartZoom);  // make sure this is done once

  // --- Initialize Leaflet map ---
  async function initMap() {
    // map = L.map('map').setView([20.5937, 78.9629], 5); // Center India;
    map = L.map('map').setView([19.7515, 75.7139], 7); // Maharashtra center and zoom


    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //   maxZoom: 18,
    //   attribution: 'Â© OpenStreetMap'
    // }).addTo(map);
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: 'Â© OpenStreetMap'
    });
    const googleSat= L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
      attribution: '&copy; Esri, HERE, Garmin, Â© OpenStreetMap contributors'
    });
    const googleSat1 = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19,
      attribution: ''
    });
    osm.addTo(map);
    const satelliteWithBoundaries = L.layerGroup([googleSat, googleSat1]);
    const baseMaps = { "OpenStreetMap": osm, "Google Satellite": satelliteWithBoundaries };
      L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
    const districtResponse = await fetch("{% static 'districts_rev21june23.geojson' %}");
    const districtData = await districtResponse.json();
    
    districtLayer = L.geoJSON(districtData, {
        style: { color: "#3388ff", weight: 2, fillOpacity: 0.1 }
    }).addTo(map); 
    
    markerLayer = L.layerGroup().addTo(map);
  }
  initMap();

  // --- Alert Helper ---
  function showAlert(msg, type="warning", dur=4000){
    dynamicAlert.innerText = msg;
    dynamicAlert.className = `alert alert-${type} alert-dismissible fade show`;
    dynamicAlert.style.display = "block";
    setTimeout(()=>{
      dynamicAlert.classList.remove("show");
      dynamicAlert.classList.add("hide");
      setTimeout(()=>dynamicAlert.style.display="none",500);
    }, dur);
  }

  // --- Populate APMCs ---
  async function populateApmc(){
    const commodity = commoditySelect.value;
    const startDate = lineStartDate.value;
    const endDate = lineEndDate.value;

    if(!commodity || !startDate || !endDate){ 
      apmcSelect.innerHTML = '<option value="">Select APMC</option>'; 
      apmcSelect.disabled = true; 
      return; 
    }

    try{
      const res = await fetch(`/api/webdata_prices_public/?commodity=${encodeURIComponent(commodity)}&start_date=${startDate}&end_date=${endDate}`);
      const dataList = await res.json();

      const uniqueApmcs = [...new Set(dataList.map(d => d.apmc))].sort();
      apmcSelect.innerHTML = '<option value="">All APMCs</option>';
      uniqueApmcs.forEach(a=>{
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        apmcSelect.appendChild(opt);
      });
      apmcSelect.disabled = uniqueApmcs.length === 0;

      // --- Add markers ---
      markerLayer.clearLayers();
      dataList.forEach(d=>{
        if (d.lat && d.lon) {
          L.circleMarker([d.lat, d.lon], {
            radius: 8,
            color: '#007bff',
            fillColor: '#00b4d8',
            fillOpacity: 0.5,
            weight: 2
          }).addTo(markerLayer)
            .bindPopup(`<b>${d.apmc}</b><br>${d.commodity}<br>â‚¹${d.modalprice}`);
        }
      });

    }catch(err){
      console.error(err);
      apmcSelect.disabled = true;
    }
  }
//   async function loadAhmednagarAPMCs(selectedApmc, commodity, startDate, endDate) {
//   const params = new URLSearchParams({
//     apmc_name: selectedApmc || "",
//     variety: commodity || "",
//     start_date: startDate || "",
//     end_date: endDate || ""
//   });

//   try {
//     const res = await fetch(`/ahmedapmc/?${params.toString()}`);
//     const data = await res.json();

//     // Clear previous markers from markerLayer (if you want a fresh layer)
//     markerLayer.clearLayers();

//     // Add new markers for Ahmednagar
//     data.locations.forEach(loc => {
//       const isSelected = selectedApmc && loc.apmc_name === selectedApmc;
//       const marker = L.circleMarker([loc.lat, loc.lon], {
//         radius: 8,
//         color: isSelected ? "red" : "blue",
//         fillColor: isSelected ? "#ff3333" : "#3399ff",
//         fillOpacity: 0.6,
//         weight: 2
//       }).bindPopup(`<b>${loc.apmc_name}</b>`);

//       // ðŸ”¹ Add click event for this marker
//       marker.on("click", () => {
//         // 1. Update dropdown
//         const apmcSelect = document.getElementById("apmcSelect");
//         apmcSelect.value = loc.apmc_name;

//         // 2. Close popup
//         marker.closePopup();

//         // 3. Trigger chart reload for this APMC
//         fetchLineChart();
//       });

//       marker.addTo(markerLayer);
//     });

//     if (data.locations.length > 0) {
//       map.fitBounds(L.latLngBounds(data.locations.map(l => [l.lat, l.lon])), { padding: [30, 30] });
//       document.getElementById("mapOverlay").style.display = "none";
//     } else {
//       document.getElementById("mapOverlay").style.display = "block";
//     }

//   } catch (error) {
//     console.error("Error loading Ahmednagar APMCs:", error);
//   }
// }
async function loadAhmednagarAPMCs(selectedApmc, commodity, startDate, endDate) {

  if (!selectedApmc) {
  Swal.fire({
    icon: "info",
    title: "Data not available",
    html: "Data not available for selected date range for chosen APMC.<br> Showing average prices for all apmcs within date range. ",
    confirmButtonColor: "#3085d6"
  });
  return;
}

  const params = new URLSearchParams({
    apmc_name: selectedApmc || "",
    variety: commodity || "",
    start_date: startDate || "",
    end_date: endDate || ""
  });

  try {
    let res = await fetch(`/ahmedapmc/?${params.toString()}`);
    let data = await res.json();

    // If no data for selected period, try a nearby date range (Â±15 days)
    if (!data.locations || data.locations.length === 0) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const prevStart = new Date(start);
      const nextEnd = new Date(end);
      prevStart.setDate(start.getDate() - 15);
      nextEnd.setDate(end.getDate() + 15);

      const nearbyParams = new URLSearchParams({
        apmc_name: selectedApmc || "",
        variety: commodity || "",
        start_date: prevStart.toISOString().split("T")[0],
        end_date: nextEnd.toISOString().split("T")[0]
      });

      const altRes = await fetch(`/ahmedapmc/?${nearbyParams.toString()}`);
      const altData = await altRes.json();

      if (altData.locations && altData.locations.length > 0) {
        Swal.fire({
          icon: "info",
          title: "No Data for Selected Dates",
          text: "Showing nearby available period instead (Â±15 days).",
          confirmButtonColor: "#3085d6"
        });
        data = altData;
      } else {
        Swal.fire({
          icon: "warning",
          title: "No Data Available",
          text: "No records found for the selected APMC and nearby dates. Try another date range or APMC.",
          confirmButtonColor: "#d33"
        });
        document.getElementById("mapOverlay").style.display = "block";
        map.setView([19.7515, 75.7139], 7);
        return;
      }
    }

    // Clear previous markers
    markerLayer.clearLayers();

    // Add markers for APMC locations
    data.locations.forEach(loc => {
      const isSelected = selectedApmc && loc.apmc_name === selectedApmc;
      const marker = L.circleMarker([loc.lat, loc.lon], {
        radius: 8,
        color: isSelected ? "red" : "blue",
        fillColor: isSelected ? "#ff3333" : "#3399ff",
        fillOpacity: 0.6,
        weight: 2
      }).bindPopup(`<b>${loc.apmc_name}</b>`);

      // On click: select and reload chart
      marker.on("click", () => {
        const apmcSelect = document.getElementById("apmcSelect");
        apmcSelect.value = loc.apmc_name;
        marker.closePopup();
        fetchLineChart();
      });

      marker.addTo(markerLayer);
    });

    // Zoom to APMC markers
    if (data.locations.length > 0) {
      map.fitBounds(L.latLngBounds(data.locations.map(l => [l.lat, l.lon])), { padding: [30, 30] });
      document.getElementById("mapOverlay").style.display = "none";
    }

  } catch (error) {
    console.error("Error loading Ahmednagar APMCs:", error);
    Swal.fire({
      icon: "error",
      title: "Error Fetching Data",
      text: "Something went wrong while fetching APMC data.",
    });
  }
}


  // --- Fetch Chart ---
  async function fetchLineChart() {
  const ctx = document.getElementById("agmarkLineChart").getContext("2d");
  const spinner = document.getElementById("loading-spinner");
  const chartContainer = document.getElementById("chartContainer");

  if (agmarkLineChart) agmarkLineChart.destroy();

  const commodity = commoditySelect.value;
  const apmc = apmcSelect.value;
  const startDate = lineStartDate.value;
  const endDate = lineEndDate.value;

  if (!commodity || !startDate || !endDate) {
    showAlert("Please select commodity and date range first");
    return;
  }

  try {
    // ðŸ”¹ Show spinner
    spinner.style.display = "block";
    chartContainer.style.opacity = "0.4";

    let url = `/api/webdata_prices_public/?source=agmark&commodity=${encodeURIComponent(commodity)}`;
    if (apmc) url += `&apmc=${encodeURIComponent(apmc)}`;
    url += `&start_date=${startDate}&end_date=${endDate}`;

    const res = await fetch(url);
    const dataList = await res.json();

    if (!Array.isArray(dataList) || dataList.length === 0) {
      Swal.fire({
        icon: "warning",
        title: "No Data Found",
        text: "No records available for the selected APMC and date range. Checking nearby (Â±15 days)...",
        confirmButtonColor: "#d33"
      });

      // âœ… Still attempt to load APMC markers with fallback logic
      await loadAhmednagarAPMCs(apmcSelect.value, commodity, lineStartDate.value, lineEndDate.value);
    return;
  }


    const grouped = {};
    dataList.forEach(d => {
      const dateStr = d.date.split("T")[0];
      if (!grouped[dateStr]) grouped[dateStr] = { min: [], modal: [], max: [] };
      grouped[dateStr].min.push(d.minprice || 0);
      grouped[dateStr].modal.push(d.modalprice || 0);
      grouped[dateStr].max.push(d.maxprice || 0);
    });

    const labels = Object.keys(grouped).sort();
    const minData = labels.map(dt => grouped[dt].min.reduce((a,b)=>a+b,0)/grouped[dt].min.length);
    const modalData = labels.map(dt => grouped[dt].modal.reduce((a,b)=>a+b,0)/grouped[dt].modal.length);
    const maxData = labels.map(dt => grouped[dt].max.reduce((a,b)=>a+b,0)/grouped[dt].max.length);

    agmarkLineChart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Min", data: minData, borderColor: "#007bff", tension: 0.3,borderWidth: 1, pointRadius: 2, pointHoverRadius: 8, pointBorderWidth: 1.5},
          { label: "Modal", data: modalData, borderColor: "#ffc107", tension: 0.3,borderWidth: 1, pointRadius: 2, pointHoverRadius: 8, pointBorderWidth: 1.5},
          { label: "Max", data: maxData, borderColor: "#28a745", tension: 0.3 ,borderWidth: 1, pointRadius: 2, pointHoverRadius: 8, pointBorderWidth: 1.5},
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: { top: 10, bottom: 0, left: 0, right: 0 }  // âœ… minimal padding
        },
        plugins: {
          legend: { position: "top" },
          zoom: {
            pan: {
              enabled: true,
              mode: "x",
              modifierKey: "ctrl"   // optional: require Ctrl for panning
            },
            zoom: {
              wheel: { enabled: true },  // âœ… enables scroll wheel zoom
              pinch: { enabled: true },  // âœ… touch pinch zoom
              drag: { enabled: false },
              mode: "x"
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return `â‚¹ ${context.raw.toFixed(0)} per quintal`;
              }
            }
          }
        },
        scales: {
          y: {
            title: { display: true, text: "Price (â‚¹ per Quintal)" },
            beginAtZero: true
          },
          x: { title: { display: true, text: "Date" } }
        }
      }
    });

  } catch (err) {
    console.error(err);
    showAlert("Error loading line chart");
  } finally {
    // ðŸ”¹ Hide spinner regardless of success or error
    spinner.style.display = "none";
    chartContainer.style.opacity = "1";
  }
  loadAhmednagarAPMCs(apmcSelect.value, commodity, lineStartDate.value, lineEndDate.value);
}


  // --- Event Listeners ---
  commoditySelect.addEventListener("change", populateApmc);
  lineStartDate.addEventListener("change", populateApmc);
  lineEndDate.addEventListener("change", populateApmc);
  submitBtn.addEventListener("click", fetchLineChart);

  // --- Zoom Buttons ---
// document.getElementById("zoomInBtn").addEventListener("click", () => {
//     if (agmarkLineChart) agmarkLineChart.zoom(1.1);
// });
// document.getElementById("zoomOutBtn").addEventListener("click", () => {
//     if (agmarkLineChart) agmarkLineChart.zoom(0.9);
// });
// document.getElementById("resetZoomBtn").addEventListener("click", () => {
//     if (agmarkLineChart) agmarkLineChart.resetZoom();
// });

// --- Slider Control ---
// const slider = document.getElementById("chartSlider");
// slider.addEventListener("input", function() {
//     if (!agmarkLineChart) return;
//     const scale = this.value / 100;  // value between 0-1
//     const xScale = agmarkLineChart.scales.x;
//     const totalLabels = xScale.max - xScale.min;
//     const newMax = xScale.min + totalLabels * scale;
//     xScale.options.min = xScale.min;
//     xScale.options.max = newMax;
//     agmarkLineChart.update("none");
// });
});
</script>
{% endblock %}
