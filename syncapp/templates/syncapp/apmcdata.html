{% extends 'syncapp/base.html' %}
{% load static %}

{% block title %}Wholesale Market Prices{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

<style>
  /* FILTER BAR */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-end;
    margin-bottom: 15px;
    background: #f9f9f9;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }
  .filter-bar .form-group {
    flex: 1 1 180px;
    min-width: 160px;
  }

  /* MAIN PANEL LAYOUT */
  .main-content {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .map-panel { flex:3; height:520px; background:#fff; border:1px solid #e0e0e0; border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
.chart-panel { flex:7; height:520px; background:#fff; border:1px solid #e0e0e0; border-radius:15px; box-shadow:0 2px 6px rgba(0,0,0,0.08); display:flex; flex-direction:column; }
  
  #map {
    flex: 1;
    width: 100%;
    border-radius: 15px;
  }
  .chart-panel h5 {
    background: linear-gradient(90deg, #007bff, #00b4d8);
    color: #fff;
    text-align: center;
    margin: 0;
    padding: 10px;
    border-radius: 15px 15px 0 0;
    font-size: 1rem;
  }
  .chart-panel canvas {
    flex: 1;
    padding: 10px;
  }

  @media (max-width: 768px) {
    .main-content {
      flex-direction: column;
    }
    .map-panel, .chart-panel {
      width: 100%;
      height: 400px;
    }
  }

  .map-panel {
    position: relative;
  }

  #mapOverlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.5); /* lighter overlay */
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 1.3rem;
    font-weight: 600;
    color: #222;
    backdrop-filter: blur(3px); /* subtle glass effect */
    z-index: 500;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    pointer-events: none; /* allows map panning/zooming */
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3 text-primary">Wholesale Market Prices</h2>
  <div id="dynamicAlert" class="alert alert-warning alert-dismissible fade show" style="display:none;"></div>

  <!-- FILTER BAR -->
  <div class="filter-bar">
    <div class="form-group">
      <label for="commoditySelect" class="form-label">Commodity</label>
      <select id="commoditySelect" class="form-select w-100">
        <option value="">All Commodities</option>
        {% for item in commodities %}
        <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="form-group">
      <label for="lineStartDate" class="form-label">Start Date</label>
      <input type="date" id="lineStartDate" class="form-control w-100"
             value="{{ today|date:'Y-m-d' }}" min="2025-08-11" max="{{ today|date:'Y-m-d' }}">
    </div>

    <div class="form-group">
      <label for="lineEndDate" class="form-label">End Date</label>
      <input type="date" id="lineEndDate" class="form-control w-100"
             value="{{ today|date:'Y-m-d' }}" min="2025-08-11" max="{{ today|date:'Y-m-d' }}">
    </div>

    <div class="form-group">
      <label for="apmcSelect" class="form-label">APMC</label>
      <select id="apmcSelect" class="form-select w-100" disabled>
        <option value="">Select APMC</option>
      </select>
    </div>

    <div class="form-group">
      <button id="submitBtn" class="btn btn-primary w-100">Show Prices</button>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content mt-3">
    <div class="map-panel">
      <div id="map"></div>
      <div id="mapOverlay">üó∫Ô∏è Coming Soon</div>
  </div>

    <div class="chart-panel">
      <h5>AgmarkNet Prices Trend </h5>
      <div class="chart-panel">
        <div class="chart-header">
          <button id="zoomInBtn" class="btn btn-sm btn-primary">Zoom In</button>
          <button id="zoomOutBtn" class="btn btn-sm btn-primary">Zoom Out</button>
          <button id="resetZoomBtn" class="btn btn-sm btn-secondary">Reset</button>
          
        </div>
        <input type="range" id="chartSlider" min="0" max="100" value="0" style="width:150px;">
        <div id="chartContainer">
          <canvas id="agmarkLineChart"></canvas>
        </div>
      </div>
      <canvas id="agmarkLineChart"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const commoditySelect = document.getElementById("commoditySelect");
  const apmcSelect = document.getElementById("apmcSelect");
  const lineStartDate = document.getElementById("lineStartDate");
  const lineEndDate = document.getElementById("lineEndDate");
  const submitBtn = document.getElementById("submitBtn");
  const dynamicAlert = document.getElementById("dynamicAlert");

  let agmarkLineChart = null;
  let map, markerLayer;
 
  Chart.register(ChartZoom);  // make sure this is done once

  // --- Initialize Leaflet map ---
  function initMap() {
    map = L.map('map').setView([19.5, 79.6], 7);
    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //   maxZoom: 18,
    //   attribution: '¬© OpenStreetMap'
    // }).addTo(map);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        maxZoom: 18,
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and others'
    }).addTo(map);

    markerLayer = L.layerGroup().addTo(map);
  }
  initMap();

  // --- Alert Helper ---
  function showAlert(msg, type="warning", dur=4000){
    dynamicAlert.innerText = msg;
    dynamicAlert.className = `alert alert-${type} alert-dismissible fade show`;
    dynamicAlert.style.display = "block";
    setTimeout(()=>{
      dynamicAlert.classList.remove("show");
      dynamicAlert.classList.add("hide");
      setTimeout(()=>dynamicAlert.style.display="none",500);
    }, dur);
  }

  // --- Populate APMCs ---
  async function populateApmc(){
    const commodity = commoditySelect.value;
    const startDate = lineStartDate.value;
    const endDate = lineEndDate.value;

    if(!commodity || !startDate || !endDate){ 
      apmcSelect.innerHTML = '<option value="">Select APMC</option>'; 
      apmcSelect.disabled = true; 
      return; 
    }

    try{
      const res = await fetch(`/api/webdata_prices_public/?commodity=${encodeURIComponent(commodity)}&start_date=${startDate}&end_date=${endDate}`);
      const dataList = await res.json();

      const uniqueApmcs = [...new Set(dataList.map(d => d.apmc))].sort();
      apmcSelect.innerHTML = '<option value="">All APMCs</option>';
      uniqueApmcs.forEach(a=>{
        const opt = document.createElement("option");
        opt.value = a;
        opt.textContent = a;
        apmcSelect.appendChild(opt);
      });
      apmcSelect.disabled = uniqueApmcs.length === 0;

      // --- Add markers ---
      markerLayer.clearLayers();
      dataList.forEach(d=>{
        if (d.lat && d.lon) {
          L.circleMarker([d.lat, d.lon], {
            radius: 8,
            color: '#007bff',
            fillColor: '#00b4d8',
            fillOpacity: 0.5,
            weight: 2
          }).addTo(markerLayer)
            .bindPopup(`<b>${d.apmc}</b><br>${d.commodity}<br>‚Çπ${d.modalprice}`);
        }
      });

    }catch(err){
      console.error(err);
      apmcSelect.disabled = true;
    }
  }

  // --- Fetch Chart ---
  async function fetchLineChart() {
    const ctx = document.getElementById("agmarkLineChart").getContext("2d");
    if (agmarkLineChart) agmarkLineChart.destroy();

    const commodity = commoditySelect.value;
    const apmc = apmcSelect.value;
    const startDate = lineStartDate.value;
    const endDate = lineEndDate.value;

    if (!commodity || !startDate || !endDate) {
      showAlert("Please select commodity and date range first");
      return;
    }

    try {
      let url = `/api/webdata_prices_public/?source=agmark&commodity=${encodeURIComponent(commodity)}`;
      if (apmc) url += `&apmc=${encodeURIComponent(apmc)}`;
      url += `&start_date=${startDate}&end_date=${endDate}`;

      const res = await fetch(url);
      const dataList = await res.json();
      if (!Array.isArray(dataList) || dataList.length === 0) {
        showAlert("No data available for selected criteria", "info");
        return;
      }

      const grouped = {};
      dataList.forEach(d => {
        const dateStr = d.date.split("T")[0];
        if (!grouped[dateStr]) grouped[dateStr] = { min: [], modal: [], max: [] };
        grouped[dateStr].min.push(d.minprice || 0);
        grouped[dateStr].modal.push(d.modalprice || 0);
        grouped[dateStr].max.push(d.maxprice || 0);
      });

      const labels = Object.keys(grouped).sort();
      const minData = labels.map(dt => grouped[dt].min.reduce((a,b)=>a+b,0)/grouped[dt].min.length);
      const modalData = labels.map(dt => grouped[dt].modal.reduce((a,b)=>a+b,0)/grouped[dt].modal.length);
      const maxData = labels.map(dt => grouped[dt].max.reduce((a,b)=>a+b,0)/grouped[dt].max.length);

      agmarkLineChart = new Chart(ctx, {
        type: "line",
        data: {
            labels,
            datasets: [
                { label: "Min", data: minData, borderColor: "#007bff", tension:0.3 },
                { label: "Modal", data: modalData, borderColor: "#ffc107", tension:0.3 },
                { label: "Max", data: maxData, borderColor: "#28a745", tension:0.3 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: "top" },
                zoom: {
                    pan: { enabled: true, mode: "x" },
                    zoom: { wheel: { enabled: true }, mode: "x" },
                    pinch: { enabled: true, mode: "x"  },
                }
            },
            scales: {
                y: { beginAtZero: true }
            }
            }
        });
    } catch(err) { 
      console.error(err); 
      showAlert("Error loading line chart"); 
    }
  }

  // --- Event Listeners ---
  commoditySelect.addEventListener("change", populateApmc);
  lineStartDate.addEventListener("change", populateApmc);
  lineEndDate.addEventListener("change", populateApmc);
  submitBtn.addEventListener("click", fetchLineChart);

  // --- Zoom Buttons ---
document.getElementById("zoomInBtn").addEventListener("click", () => {
    if (agmarkLineChart) agmarkLineChart.zoom(1.1);
});
document.getElementById("zoomOutBtn").addEventListener("click", () => {
    if (agmarkLineChart) agmarkLineChart.zoom(0.9);
});
document.getElementById("resetZoomBtn").addEventListener("click", () => {
    if (agmarkLineChart) agmarkLineChart.resetZoom();
});

// --- Slider Control ---
const slider = document.getElementById("chartSlider");
slider.addEventListener("input", function() {
    if (!agmarkLineChart) return;
    const scale = this.value / 100;  // value between 0-1
    const xScale = agmarkLineChart.scales.x;
    const totalLabels = xScale.max - xScale.min;
    const newMax = xScale.min + totalLabels * scale;
    xScale.options.min = xScale.min;
    xScale.options.max = newMax;
    agmarkLineChart.update("none");
});
});
</script>
{% endblock %}
