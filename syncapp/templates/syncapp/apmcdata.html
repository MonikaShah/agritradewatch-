{% extends 'syncapp/base.html' %}
{% load static %}

{% block title %}WholeSale Market Prices{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
<style>
  /* Horizontal line for inputs */
  .form-inline {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: flex-end;
    margin-bottom: 20px;
  }

  .form-inline > * {
    flex: 1 1 200px;
  }

  /* Chart container */
  .chart-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-top: 20px;
  }

  .chart-box {
    flex: 1 1 45%;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 15px;
    background: #f9f9f9;
    min-width: 300px;
  }

  .chart-box h4 {
    text-align: center;
  }

  #daySlider {
    width: 100%;
  }

  @media (max-width: 768px) {
    .chart-box {
      flex: 1 1 100%;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-3">Commodity Prices</h2>

  <!-- Horizontal Form -->
  <div class="form-inline">
    <div>
      <label for="commoditySelect"><b>Select Commodity</b></label>
      <select id="commoditySelect" class="form-control">
        {% for item in commodities %}
          <option value="{{ item }}">{{ item }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label for="dateSelect"><b>Select Date</b></label>
      <input type="date" id="dateSelect" class="form-control" value="{{ today|date:'Y-m-d' }}">
    </div>
    <div>
      <button id="submitBtn" class="btn btn-primary w-100">Show Prices</button>
    </div>
  </div>

  <!-- Slider -->
  <div class="row mb-4">
    <div class="col-12">
      <label for="daySlider"><b>View Previous Days</b></label>
      <input type="range" id="daySlider" min="0" max="7" step="1" value="0">
      <span id="daySliderValue">Today</span>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-container">
    <div class="chart-box">
      <h4>AgmarkNet Prices (₹/Kg)</h4>
      <div id="agmark-info" class="text-muted text-center">Select a commodity and date</div>
      <canvas id="agmarkChart" height="300"></canvas>
    </div>
    <div class="chart-box">
      <h4>Agrowon Prices (₹/Kg)</h4>
      <div id="agrowon-info" class="text-muted text-center">Select a commodity and date</div>
      <canvas id="agrowonChart" height="300"></canvas>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function(){

  const commoditySelect = document.getElementById("commoditySelect");
  const dateSelect = document.getElementById("dateSelect");
  const submitBtn = document.getElementById("submitBtn");

  let agmarkChart = null;
  let agrowonChart = null;

  submitBtn.addEventListener("click", fetchData);

  async function fetchData(){
    const commodity = commoditySelect.value;
    const date = dateSelect.value;

    fetchAgmarkPrices(commodity, date);
    fetchAgrowonPrices(commodity, date);
  }

  // Function to update chart without flickering
  function updateOrCreateChart(chartInstance, ctx, labels, datasets, yLabel) {
    if(chartInstance){
      chartInstance.data.labels = labels;
      chartInstance.data.datasets = datasets;
      chartInstance.options.scales.y.title.text = yLabel;
      chartInstance.update();
      return chartInstance;
    } else {
      return new Chart(ctx, {
        type: "bar",
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" } },
          scales: { y: { beginAtZero: true, title: { display: true, text: yLabel } } }
        }
      });
    }
  }

  async function fetchAgmarkPrices(commodity, date){
    const agmarkInfo = document.getElementById("agmark-info");
    const ctx = document.getElementById("agmarkChart").getContext("2d");
    agmarkInfo.innerText = "Loading...";

    try {
      const res = await fetch(`/api/webdata_prices_public/?commodity=${encodeURIComponent(commodity)}&source=agmark&date=${date}`);
      const dataList = await res.json();

      if(!dataList || dataList.length === 0){
        agmarkInfo.innerText = "No AgmarkNet data available";
        return;
      }

      const labels = [...new Set(dataList.map(d=>d.apmc || "NA"))];
      const minData = labels.map(label => dataList.find(d=>d.apmc===label)?.minprice/100 || 0);
      const modalData = labels.map(label => dataList.find(d=>d.apmc===label)?.modalprice/100 || 0);
      const maxData = labels.map(label => dataList.find(d=>d.apmc===label)?.maxprice/100 || 0);

      const datasets = [
        {label:"Min", data:minData, backgroundColor:"rgba(54,162,235,0.7)"},
        {label:"Modal", data:modalData, backgroundColor:"rgba(255,206,86,0.7)"},
        {label:"Max", data:maxData, backgroundColor:"rgba(75,192,192,0.7)"}
      ];

      agmarkChart = updateOrCreateChart(agmarkChart, ctx, labels, datasets, "₹/Kg");
      agmarkInfo.innerHTML = `<b>Commodity:</b> ${commodity}<br><b>Date:</b> ${date}`;
    } catch(err) {
      agmarkInfo.innerText = "Error loading AgmarkNet data";
      console.error(err);
    }
  }

  async function fetchAgrowonPrices(commodity, date){
    const agrowonInfo = document.getElementById("agrowon-info");
    const ctx = document.getElementById("agrowonChart").getContext("2d");
    agrowonInfo.innerText = "Loading...";

    try {
      const res = await fetch(`/api/webdata_prices_public/?commodity=${encodeURIComponent(commodity)}&source=agrowon&date=${date}`);
      const dataList = await res.json();

      if(!dataList || dataList.length === 0){
        agrowonInfo.innerText = "No Agrowon data available";
        return;
      }

      const labels = [...new Set(dataList.map(d=>d.apmc || "NA"))];
      const minData = labels.map(label => dataList.find(d=>d.apmc===label)?.minprice || 0);
      const modalData = labels.map(label => dataList.find(d=>d.apmc===label)?.modalprice || 0);
      const maxData = labels.map(label => dataList.find(d=>d.apmc===label)?.maxprice || 0);

      const datasets = [
        {label:"Min", data:minData, backgroundColor:"rgba(153,102,255,0.7)"},
        {label:"Modal", data:modalData, backgroundColor:"rgba(255,159,64,0.7)"},
        {label:"Max", data:maxData, backgroundColor:"rgba(255,99,132,0.7)"}
      ];

      agrowonChart = updateOrCreateChart(agrowonChart, ctx, labels, datasets, "₹/Quintal");
      agrowonInfo.innerHTML = `<b>Commodity:</b> ${commodity}<br><b>Date:</b> ${date}`;
    } catch(err) {
      agrowonInfo.innerText = "Error loading Agrowon data";
      console.error(err);
    }
  }

});
</script>
{% endblock %}
