{% extends "syncapp/base.html" %}
{% load static %}

{% block title %}Ahmednagar APMC Data{% endblock %}

{% block extra_head %}
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .form-section { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin: 20px 0; }
  select, input[type="date"] { padding: 6px 10px; border-radius: 8px; border: 1px solid #aaa; }
  .main-container { display: flex; gap: 20px; margin-top: 20px; }
  .left-panel, .right-panel { flex: 1; height: 75vh; background: #fff; border: 1px solid #ddd; border-radius: 16px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
  #map { flex-grow: 1; border-radius: 16px; }
  .card-header { background: linear-gradient(135deg, #6c63ff, #00d4ff); color: white; text-align: center; padding: 10px; font-weight: bold; }
  #chartContainer { flex-grow: 1; padding: 10px; height: 400px; position: relative; }
  #priceChart { height: 100% !important; width: 100%; }
  #noDataMessage { display:none; text-align:center; padding:20px; color:#555; position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="form-section">
    <label><strong>APMC:</strong></label>
    <select id="apmcSelect">
      <option value="">-- Ahmednagar APMCs --</option>
      {% for a in apmcs %}<option value="{{ a }}">{{ a }}</option>{% endfor %}
    </select>

    <label><strong>Commodity:</strong></label>
    <select id="commoditySelect"> 
      
      <option value="Other">Onion (Other)</option>
      <option value="Red">Onion (Red)</option> 
    </select>

    <label><strong>Start Date:</strong></label>
    <select id="startDate">
      <option value="">Select start date</option>
      {% for d in dates %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
    </select>

    <label><strong>End Date:</strong></label>
    <select id="endDate" disabled>
      <option value="">Select end date</option>
    </select>
  </div>

  <div class="main-container">
    <div class="left-panel">
      <div class="card-header">APMC Location Map</div>
      <div id="map"></div>
    </div>

    <div class="right-panel">
      <div class="card-header">Price Trends</div>
      <div id="chartContainer">
        <canvas id="priceChart"></canvas>
        <div id="noDataMessage">No price data for selected filters</div>
      </div>
    </div>
  </div>
</div>


<script>
document.addEventListener("DOMContentLoaded", function() {
    const map = L.map('map').setView([19.7515, 75.7139], 7);
    // L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    //     maxZoom: 18,
    //     attribution: '&copy; OpenStreetMap contributors'
    // }).addTo(map);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 18,
      attribution: 'Tiles &copy; Esri &mdash; Source: Esri, Maxar, Earthstar Geographics, and others'
    }).addTo(map);


    let apmcMarkers = [];
    let priceChart = null;

    const startSelect = document.getElementById("startDate");
    const endSelect = document.getElementById("endDate");
    const apmcSelect = document.getElementById("apmcSelect");

    // Enable end date after selecting start date
    startSelect.addEventListener("change", function() {
        const startDate = this.value;
        endSelect.innerHTML = '<option value="">Select end date</option>';
        if (startDate) {
            {% for d in dates %}
            if ("{{ d }}" >= startDate) {
                const opt = document.createElement("option");
                opt.value = "{{ d }}";
                opt.text = "{{ d }}";
                endSelect.add(opt);
            }
            {% endfor %}
            endSelect.disabled = false;
        } else { endSelect.disabled = true; }
    });

    // Fetch and render data
    function fetchAPMCData() {
        const selectedApmc = apmcSelect.value;
        const commodity = document.getElementById("commoditySelect").value;
        const startDate = startSelect.value;
        const endDate = endSelect.value;

        const canvas = document.getElementById("priceChart");
        const noDataDiv = document.getElementById("noDataMessage");

        const params = new URLSearchParams({
            apmc_name: selectedApmc,
            variety: commodity,
            start_date: startDate,
            end_date: endDate
        });

        fetch(`/ahmedapmc/?${params.toString()}`)
        .then(res => res.json())
        .then(data => {
            // Clear previous markers
            apmcMarkers.forEach(m => map.removeLayer(m));
            apmcMarkers = [];

            // Show all APMCs on map
            data.locations.forEach(loc => {
                const isSelected = selectedApmc && loc.apmc_name === selectedApmc;
                const m = L.circleMarker([loc.lat, loc.lon], {
                    radius: 8,
                    color: isSelected ? "red" : "blue",
                    fillColor: isSelected ? "#ff3333" : "#3399ff",
                    fillOpacity: 0.6
                }).addTo(map).bindPopup(`<b>${loc.apmc_name}</b>`);
                apmcMarkers.push(m);
            });

            if (data.locations.length > 0)
                map.setView([data.locations[0].lat, data.locations[0].lon], 7);

            // Price chart
            const prices = data.prices || [];
            if (prices.length === 0) {
                if (priceChart) { priceChart.destroy(); priceChart = null; }
                canvas.style.display = "none";
                noDataDiv.style.display = "block";
                return;
            }

            // Show chart
            canvas.style.display = "block";
            noDataDiv.style.display = "none";

            const labels = prices.map(p => p.date);
            const minPrices = prices.map(p => p.min_price);
            const modalPrices = prices.map(p => p.modal_price);
            const maxPrices = prices.map(p => p.max_price);

            const ctx = canvas.getContext("2d");
            if (priceChart) priceChart.destroy();

            priceChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: labels,
                    datasets: [
                        { label: "Min Price", data: minPrices, borderColor: "green", fill: false },
                        { label: "Modal Price", data: modalPrices, borderColor: "blue", fill: false },
                        { label: "Max Price", data: maxPrices, borderColor: "red", fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true } },
                    scales: {
                        x: { title: { display: true, text: "Date" } },
                        y: { title: { display: true, text: "Price (₹/quintal)" } }
                    }
                }
            });
        })
        .catch(err => console.error("Error fetching data:", err));
    }

    // Event listeners
    ["apmcSelect","commoditySelect","startDate","endDate"].forEach(id =>
        document.getElementById(id).addEventListener("change", fetchAPMCData)
    );

    // Initial load → show all APMCs
    fetchAPMCData();
});
</script>

{% endblock %}
