{% extends "syncapp/base.html" %}
{% load i18n %}

{% block title %}{% trans "Register" %}{% endblock %}

{% block content %}
<style>
    /* Hide header/navigation if any */
    /* header, nav {
        display: none !important;
    } */

    /* body {
        background: linear-gradient(135deg, #6c63ff, #00d4ff);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        margin: 0;
    } */

    .register-card {
        border-radius: 12px;
        padding: 2rem;
        background-color: #ffffff;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 450px;
         margin: 0 auto;
    }
    

    .form-floating label {
        color: #555;
    }

    .form-floating input:focus,
    .form-floating select:focus {
        border-color: #6c63ff;
        box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25);
    }

    .btn-primary {
        background-color: #6c63ff;
        border-color: #6c63ff;
    }

    .btn-primary:hover {
        background-color: #5848c2;
        border-color: #5848c2;
    }

    a {
        color: #6c63ff;
        text-decoration: none;
    }

    a:hover {
        text-decoration: underline;
    }
    .register-page {
        min-height: calc(100vh - 70px); /* navbar height */
        background: linear-gradient(135deg, #6c63ff, #00d4ff);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 2rem 1rem;
    }
    /* Override base template constraints */
        #content,
        .main-content,
        .container,
        .container-fluid {
            width: 100%;
            max-width: 100%;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }


    @media (max-width: 576px) {
        .register-card {
            padding: 1.5rem;
        }
        h2 {
            font-size: 1.5rem;
        }
        .btn {
            font-size: 0.95rem;
            padding: 0.5rem 0;
        }
    }

    @media (min-width: 576px) and (max-width: 768px) {
        .register-card {
            padding: 1.8rem;
        }
    }
</style>

<div class="register-page container-fluid d-flex">
    <div class="register-card">
        <h2 class="text-center mb-4">            
            {% blocktrans %}Register for MandiGo{% endblocktrans %}</h2>
        
        <form method="post" id="registerForm">
            {% csrf_token %}
            <div class="form-floating mb-3">
                <input type="text" name="name" id="name" class="form-control" placeholder="Name" required>
                <label for="name">{% trans "Name" %}</label>
            </div>

            <!-- Username -->
            <div class="form-floating mb-3">
                <input type="text" name="username" id="username" class="form-control" placeholder="Username" required>
                <label for="username">{% trans "Username" %}</label>
            </div>

            <!-- Email -->
            <div class="form-floating mb-3">
                <input type="email" name="email" id="email" class="form-control" placeholder="Email" required>
                <label for="email">{% trans "Email" %}</label>
            </div>

            <!-- Mobile Number -->
            <div class="form-floating mb-3">
                <input type="text" name="mobile_number" id="mobile_number" class="form-control" placeholder="Mobile Number" required>
                <label for="mobile_number">{% trans "Mobile" %}</label>
            </div>

            <!-- Job -->
            <div class="form-floating mb-3">
                <select name="job" id="job" class="form-select" required>
                    <option value="" disabled selected>{% trans "Role" %}</option>
                    <option value="consumer">{% trans "Consumer" %}</option>
                    <option value="farmer">{% trans "Farmer" %}</option>
                    <option value="retailer">{% trans "Retailer" %}</option>
                </select>
                <label for="job">{% trans "Job" %}</label>
            </div>

            <!-- Password -->
            <div class="form-floating mb-4">
                <input type="password" name="password" id="password" class="form-control" placeholder="Password" required>
                <label for="password">{% trans "Password" %}</label>
            </div>
            <div class="form-floating mb-4">
                <input type="password" name="confirm_password" id="confirm_password" class="form-control" placeholder="Confirm Password" required>
                <label for="confirm_password">{% trans "Confirm Password" %}</label>
            </div>

            <!-- Password Mismatch Error -->
            <p id="passwordError" class="text-danger" style="display:none; font-size:14px;">
                {% trans "Passwords do not match." %}
            </p>

            <!-- Hidden latitude and longitude -->
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">

            <button type="submit" class="btn btn-primary w-100 py-2">{% trans "Register" %}</button>
            <!-- 1 Added for mobile OTP verification and register -->
            <!-- <button type="button" id="sendOtpBtn">Send OTP</button>

            <div id="otpSection" style="display:none;">
                <input type="text" id="otp" placeholder="Enter OTP">
                <button type="button" id="verifyOtpBtn">Verify OTP & Register</button>
            </div> -->

            <p id="msg" style="color: green;"></p>
            <p id="err" style="color: red;"></p>

            <!-- 1 ends -->
        </form>

        <p class="text-center mt-3 mb-0">
            {% trans "Already have an account?" %} <a href="{% url 'login' %}">{% trans "Login" %}</a>
            
        </p>
    </div>
</div>

<script>
    const csrfToken = "{{ csrf_token }}";
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
        document.getElementById('latitude').value = position.coords.latitude;
        document.getElementById('longitude').value = position.coords.longitude;
    }, function(error) {
        console.warn("Geolocation error:", error);
    });
}
document.getElementById("registerForm").addEventListener("submit", function(e) {
    const pass = document.getElementById("password").value;
    const confirm = document.getElementById("confirm_password").value;
    const errorMsg = document.getElementById("passwordError");

    if (pass !== confirm) {
        e.preventDefault();
        errorMsg.style.display = "block";
        return false;
    }

    errorMsg.style.display = "none";
});
// For Mobile OTP verification and register
document.getElementById("sendOtpBtn").onclick = async function () {
    const mobile = document.getElementById("mobile_number").value;
    const msg = document.getElementById("msg");
    const err = document.getElementById("err");

    msg.textContent = "";
    err.textContent = "";

    if (!mobile || mobile.length != 10) {
        err.textContent = "Enter valid 10-digit mobile number";
        return;
    }

    const response = await fetch("/send_otp/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ mobile,purpose: "register"  })
    });

    const result = await response.json();

    if (result.message) {
        msg.textContent = "OTP sent to your mobile";
        document.getElementById("otpSection").style.display = "block";
    } else {
        err.textContent = result.error || "Failed to send OTP";
    }
};

document.getElementById("verifyOtpBtn").onclick = async function () {
    const msg = document.getElementById("msg");
    const err = document.getElementById("err");

    msg.textContent = "";
    err.textContent = "";

    const data = {
        name: document.getElementById("name").value,
        username: document.getElementById("username").value,
        email: document.getElementById("email").value,
        mobile: document.getElementById("mobile_number").value,
        job: document.getElementById("job").value,
        password: document.getElementById("password").value,
        otp: document.getElementById("otp").value,
        latitude: document.getElementById("latitude").value,
        longitude: document.getElementById("longitude").value,
        purpose: "register"
    };

    if (!data.otp) {
        err.textContent = "Enter OTP";
        return;
    }

    const response = await fetch("{% url 'verify_otp' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
        },
        body: JSON.stringify(data)
    });

    const result = await response.json();

    if (result.status === "success") {
        msg.textContent = "Registration successful. Redirecting...";
        setTimeout(() => {
            window.location.href = "{% url 'login' %}";
        }, 1500);
    } else {
        err.textContent = result.error || "OTP verification failed";
    }
};
</script>
{% endblock %}
