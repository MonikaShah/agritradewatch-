{% extends "syncapp/base.html" %}
{% load static %}

{% block title %}Add Produce{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-sm mx-auto" style="max-width: 600px;">
    <div class="card-body">
      <h3 class="card-title text-center mb-4">Welcome {{ thela_username }}<br>Add Produce Details</h3>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}
        {{ form.as_p }}

        <!-- Hidden location fields -->
        <input type="hidden" id="id_latitude" name="latitude">
        <input type="hidden" id="id_longitude" name="longitude">
        <input type="hidden" id="id_timestamp" name="timestamp">

        <!-- Location enable button -->
        <div class="mb-3 text-center">
          <button type="button" id="enableLocationBtn" class="btn btn-outline-primary btn-sm">
            üìç Enable Location
          </button>
          <small id="locationStatus" class="text-muted d-block mt-2">
            Click above to enable your location before submitting.
          </small>
        </div>

        <div class="d-grid mt-3">
          <button type="submit" class="btn btn-success btn-block">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  body {
    background-color: #f7f9fc;
  }
  .card {
    border-radius: 1rem;
  }
  input, select, textarea {
    border-radius: 0.5rem !important;
  }
  @media (max-width: 576px) {
    .card {
      margin: 10px;
    }
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const btn = document.getElementById("enableLocationBtn");
  const latInput = document.getElementById("id_latitude");
  const lonInput = document.getElementById("id_longitude");
  const status = document.getElementById("locationStatus");
  const timestampInput = document.getElementById("id_timestamp");

  // Automatically set timestamp when page loads
  if (timestampInput) {
    timestampInput.value = new Date().toISOString();
  }

  // Try to auto-fetch location on page load
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function (pos) {
        const lat = pos.coords.latitude.toFixed(7);
        const lon = pos.coords.longitude.toFixed(7);
        latInput.value = lat;
        lonInput.value = lon;
        status.textContent = "‚úÖ Location captured automatically.";
        status.classList.add("text-success");
      },
      function (err) {
        console.warn("Auto-location failed:", err.message);
        status.textContent = "üìç Click the button to enable location.";
      }
    );
  }

  // Manual button-based location fetch
  if (btn) {
    btn.addEventListener("click", function () {   
      if (!navigator.geolocation) {
        status.textContent = "‚ùå Geolocation is not supported by your browser.";
        status.classList.add("text-danger");
        return;
      }

      status.textContent = "Fetching your location...";
      navigator.geolocation.getCurrentPosition(
        function (pos) {
          const lat = pos.coords.latitude.toFixed(7);
          const lon = pos.coords.longitude.toFixed(7);
          latInput.value = lat;
          lonInput.value = lon;
          console.log("‚úÖ Location captured:", lat, lon);
          status.textContent = "‚úÖ Location captured successfully!";
          status.classList.remove("text-danger");
          status.classList.add("text-success");
        },
        function (err) {
          console.error("Location error:", err);
          status.textContent = "‚ùå Please allow location access and try again.";
          status.classList.add("text-danger");
        }
      );
    });
  }

  // Commodity dropdown logic (unchanged)
  const select = document.getElementById("id_sale_commodity");
  if (select) {
    select.addEventListener("change", () => {
      if (select.value === "add_new") {
        const newCommodity = prompt("Enter the new commodity name:");
        if (newCommodity) {
          const option = new Option(newCommodity, newCommodity.toLowerCase(), true, true);
          select.add(option);
        } else {
          select.value = "";
        }
      }
    });
  }
});
</script>
{% endblock %}
