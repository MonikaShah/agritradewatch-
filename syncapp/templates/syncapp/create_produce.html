{% extends "syncapp/base.html" %}
{% load static %}
{% block title %}Add Produce{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="card shadow-sm mx-auto p-3" style="max-width:600px;">
    <div class="card-body">
      <h3 class="card-title text-center mb-4">
        Welcome {{ thela_username }}<br>Add Produce Details
      </h3>

      {% if messages %}
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
      {% endif %}

      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <!-- Commodity -->
        <div class="mb-3">
          <label for="id_sale_commodity" class="form-label">Commodity</label>
          <select id="id_sale_commodity" name="sale_commodity" class="form-select">
            <option value="">-- Select Commodity --</option>
            {% for com in commodity_list %}
              <option value="{{ com }}">{{ com }}</option>
            {% endfor %}
            <option value="Other">Other</option> <!-- Show input for new commodity -->
          </select>
        </div>

        <div class="mb-3" id="newCommodityDiv" style="display:none;">
          <label for="id_new_commodity" class="form-label">New Commodity</label>
          <input type="text" id="id_new_commodity" name="new_commodity" class="form-control">
        </div>

        <!-- Other visible fields -->
        {% for field in form %}
          {% if not field.is_hidden and field.name not in "sale_commodity new_commodity description_voice"  %}
            <div class="mb-3">
              {{ field.label_tag }}
              {{ field }}
              {{ field.errors }}
            </div>
          {% endif %}
        {% endfor %}
        <!-- Voice Description -->
        <div class="mb-3">
  <label class="form-label">Voice Description</label>
  <div class="btn-group w-100 mb-2" role="group" id="voiceToggle">
    <button type="button" class="btn btn-outline-primary active" data-mode="upload">Upload</button>
    <button type="button" class="btn btn-outline-primary" data-mode="record">Record</button>
  </div>

  <!-- Upload -->
  <div id="uploadDiv">
    <input type="file" accept="audio/*" name="description_voice" id="voiceUpload" class="form-control">
  </div>

  <!-- Record -->
  <div id="recordDiv" style="display:none;">
    <div class="d-flex gap-2">
      <button type="button" id="startRecording" class="btn btn-outline-primary">üé§ Start</button>
      <button type="button" id="stopRecording" class="btn btn-outline-danger" disabled>‚èπ Stop</button>
    </div>
    <audio id="audioPlayback" controls style="display:none; margin-top:10px;"></audio>
  </div>
</div>


        <h6><b>Drag the marker OR choose district and Tehsil to change the location.</b></h6>

        <!-- State / District / Tehsil selects -->
        <div class="mt-3">
          <label class="fw-bold">State</label>
          <select id="stateSelect" class="form-select mb-2">
            <option value="">-- Select State --</option>
          </select>

          <label class="fw-bold">District</label>
          <select id="districtSelect" class="form-select mb-2" disabled>
            <option value="">-- Select District --</option>
          </select>

          <label class="fw-bold">Tehsil</label>
          <select id="tehsilSelect" class="form-select mb-3" disabled>
            <option value="">-- Select Tehsil --</option>
          </select>
        </div>

        <!-- Map -->
        <div id="map" style="height:320px;border-radius:12px;" class="shadow mb-3"></div>

        <button type="button" id="confirmLocationBtn" class="btn btn-primary w-100 mb-3">
          Confirm Location
        </button>

        <!-- Hidden fields for POST -->
        <input type="hidden" id="locationConfirmed" name="location_confirmed" value="false">
        <input type="hidden" id="finalLat" name="latitude">
        <input type="hidden" id="finalLon" name="longitude">
        
        <div class="d-grid">
          <button type="submit" class="btn btn-success w-100">Submit</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
body{background:#f7f9fc;}
.card{border-radius:1rem;}
input,select,textarea{border-radius:0.5rem!important;}
@media(max-width:576px){.card{margin:10px;}}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Show new commodity input if selected
    const select = document.getElementById("id_sale_commodity");
    const newDiv = document.getElementById("newCommodityDiv");
    select.addEventListener("change", function() {
        if (this.value === "Other") {
            newDiv.style.display = "block";
        } else {
            newDiv.style.display = "none";
            document.getElementById("id_new_commodity").value = "";
        }
    });
    const form = select.closest("form");
    form.addEventListener("submit", function(e) {
        const newInput = document.getElementById("id_new_commodity");
        if (newInput.value.trim() !== "") {
            const newCommodity = newInput.value.trim();
            let exists = Array.from(select.options).some(opt => opt.value.toLowerCase() === newCommodity.toLowerCase());
            if (!exists) {
                const option = new Option(newCommodity, newCommodity, true, true);
                select.add(option);
            }
            select.value = newCommodity;
        }
    });


    // Location data from Django
    const locationData = JSON.parse('{{ location_data_json|escapejs }}');
        console.log(locationData);  // ‚úÖ Check in browser console

    const stateSelect = document.getElementById("stateSelect");
    const districtSelect = document.getElementById("districtSelect");
    const tehsilSelect = document.getElementById("tehsilSelect");
    const finalLat = document.getElementById("finalLat");
    const finalLon = document.getElementById("finalLon");
    const locationConfirmed = document.getElementById("locationConfirmed");

    // Initialize map
    let map = L.map("map").setView([19.7515, 75.7139], 6);
    L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", {
        maxZoom: 20,
        attribution: "&copy; Google"
    }).addTo(map);
    let marker = L.marker([19.7515,75.7139], {draggable:true}).addTo(map);

    // Update hidden fields on marker drag
    marker.on("dragend", () => {
        const p = marker.getLatLng();
        finalLat.value = p.lat.toFixed(7);
        finalLon.value = p.lng.toFixed(7);
    });

    // Populate State dropdown
    Object.keys(locationData).forEach(s => stateSelect.add(new Option(s,s)));

    // Populate District
    stateSelect.addEventListener("change", function(){
        districtSelect.innerHTML = "<option value=''>-- Select District --</option>";
        tehsilSelect.innerHTML = "<option value=''>-- Select Tehsil --</option>";
        districtSelect.disabled = true;
        tehsilSelect.disabled = true;
        if(!this.value) return;
        // Sorted districts
        const districts = Object.keys(locationData[this.value]).sort();
        districts.forEach(d => districtSelect.add(new Option(d,d)));
        districtSelect.disabled = false;
        
    });

    // Populate Tehsil
    districtSelect.addEventListener("change", function(){
        tehsilSelect.innerHTML = "<option value=''>-- Select Tehsil --</option>";
        tehsilSelect.disabled = true;
        if(!this.value) return;
        const state = stateSelect.value;
        const tehsils = locationData[state][this.value].slice().sort();
        tehsils.forEach(t => tehsilSelect.add(new Option(t,t)));
        tehsilSelect.disabled = false;
        });

    // Move marker when Tehsil is selected
    tehsilSelect.addEventListener("change", function(){
        if(!this.value) return;
        const address = `${this.value}, ${districtSelect.value}, ${stateSelect.value}, India`;
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`)
            .then(res => res.json())
            .then(data => {
                if(data.length > 0){
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    map.setView([lat,lon],14);
                    marker.setLatLng([lat,lon]);
                    finalLat.value = lat.toFixed(7);
                    finalLon.value = lon.toFixed(7);
                }
            });
    });

    // Confirm location button
    document.getElementById("confirmLocationBtn").addEventListener("click", function(){
        if(!finalLat.value || !finalLon.value) return alert("Move marker or select location first.");
        locationConfirmed.value = "true";
        this.classList.remove("btn-primary");
        this.classList.add("btn-success");
        this.innerText = "Location Confirmed ‚úÖ";
    });
    // Custom control for "Current Location"
const locateControl = L.Control.extend({
    options: { position: 'topleft' }, // position like Google Maps
    onAdd: function(map) {
        const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        container.style.backgroundColor = 'white';
        container.style.width = '34px';
        container.style.height = '34px';
        container.style.cursor = 'pointer';
        container.style.display = 'flex';
        container.style.alignItems = 'center';
        container.style.justifyContent = 'center';
        container.style.fontSize = '18px';
        container.title = "Get Current Location";
        container.innerHTML = 'üìç'; // pin emoji, you can replace with an icon

        container.onclick = function() {
            if (!navigator.geolocation) {
                alert("Geolocation is not supported by your browser.");
                return;
            }
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    // Move marker
                    marker.setLatLng([lat, lon]);

                    // Center map
                    map.setView([lat, lon], 14);

                    // Update hidden fields
                    finalLat.value = lat.toFixed(7);
                    finalLon.value = lon.toFixed(7);

                    // Do NOT confirm location automatically
                    alert("Marker moved to your current location. Click 'Confirm Location' to confirm.");
                },
                (err) => {
                    console.error(err);
                    alert("Unable to retrieve your location. Please allow location access.");
                }
            );
        };
        return container;
    }
});
map.addControl(new locateControl());

// Toggle between upload and record
const voiceToggle = document.getElementById("voiceToggle");
const uploadDiv = document.getElementById("uploadDiv");
const recordDiv = document.getElementById("recordDiv");
const voiceUpload = document.getElementById("voiceUpload");
const audioPlayback = document.getElementById("audioPlayback");
const descriptionVoice = document.getElementById("descriptionVoice");

voiceToggle.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", () => {
        // Set active button
        voiceToggle.querySelectorAll("button").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (btn.dataset.mode === "upload") {
            uploadDiv.style.display = "block";
            recordDiv.style.display = "none";
            audioPlayback.style.display = "none";
            descriptionVoice.value = ""; // clear previous
        } else {
            uploadDiv.style.display = "none";
            recordDiv.style.display = "block";
            descriptionVoice.value = ""; // clear previous
        }
    });
});

// Handle file upload
voiceUpload.addEventListener("change", function() {
    if (this.files.length > 0) {
        const file = this.files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            descriptionVoice.value = reader.result; // Base64 string
        };
        reader.readAsDataURL(file);

        audioPlayback.src = URL.createObjectURL(file);
        audioPlayback.style.display = "block";
    }
});

// Recording logic
let mediaRecorder;
let audioChunks = [];
const formEl = document.querySelector("form");
const startBtn = document.getElementById("startRecording");
const stopBtn = document.getElementById("stopRecording");

startBtn.addEventListener("click", async () => {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.start();
    startBtn.disabled = true;
    stopBtn.disabled = false;
});

stopBtn.addEventListener("click", () => {
    mediaRecorder.stop();
    startBtn.disabled = false;
    stopBtn.disabled = true;

    mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, { type: "audio/webm" });

        // Replace the file input with recorded file
        const fileInput = document.getElementById("voiceUpload");
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(new File([blob], "recording.webm", { type: blob.type }));
        fileInput.files = dataTransfer.files;

        // Show playback
        const audioPlayback = document.getElementById("audioPlayback");
        audioPlayback.src = URL.createObjectURL(blob);
        audioPlayback.style.display = "block";
    };
});

});
</script>
{% endblock %}
