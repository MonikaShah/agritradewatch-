{% extends 'syncapp/base.html' %}
{% load static %}

{% block title %}Consumers Map{% endblock %}

{% block extra_head %}
<!-- Any page-specific CSS -->
<link rel="stylesheet" href="{% static 'syncapp/css/map.css' %}">
{% endblock %}

{% block content %}

<div id="map-container">
 <div id="map"></div>
  <div id="map-controls">
    <!-- <button id="toggle-left-panel">‚ò∞ Filters</button><br><br> -->
     <!-- Toggle button -->
    <label for="crop-select"><strong>Select Crop:</strong></label>
    <select id="crop-select">
      <option value="onion" selected>Onion</option>
      <option value="tomato">Tomato</option>
      <option value="drumstick">Drumstick</option>
      <option value="lemon">Lemon</option>
    </select>
    <hr>
    <div id="left-panel">
      <button id="locateBtn">üìç My Location</button>
      <label>Radius: <span id="radiusValue">100</span> m</label>
      <input type="range" id="radiusSlider" min="50" max="700" step="50" value="100" list="tickmarks">
      <datalist id="tickmarks">
        <option value="50" label="50m"></option>
        <option value="100" label="100m"></option>
        <option value="200" label="200m"></option>
        <option value="300" label="300m"></option>
        <option value="400" label="400m"></option>
        <option value="500" label="500m"></option>
        <option value="600" label="600m"></option>
        <option value="700" label="700m"></option>
      </datalist>
    </div>
  </div>
  <button id="toggle-map-controls">‚öôÔ∏è Hide/Show</button>
</div>

<div id="right-panel">
  <div class="box" id="graph-box">
    <h3>Consumer Reported Buying Price : <span id="selected-crop"></span></h3>
    <div id="box1-consumer">
      Average Consumer Price: <span id="avg-price">--</span>
    </div>
    <canvas id="chartCanvas"></canvas>
  </div>

  <div class="box" id="farmer-box">
    <h3>Farmer Reported Selling Price</h3>
    <div id="farmer-info"></div>
  </div>

  <div class="box" id="agrowon-box">
    <h3>Agrowon Price</h3>
    <div id="agrowon-info">Click on a marker</div>
    <canvas id="agrowonBoxChart"></canvas>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const cropSelect = document.getElementById("crop-select");
    const selectedCropSpan = document.getElementById("selected-crop");
    selectedCropSpan.innerText = cropSelect.value;

    cropSelect.addEventListener("change", function() {
        selectedCropSpan.innerText = this.value;
    });

    const map = L.map('map',{ zoomControl: false }).setView([19.2, 73.0], 7);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
    const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { attribution: '&copy; Google' });
    googleSat.addTo(map);

    const baseMaps = { "OpenStreetMap": osm, "Google Satellite": googleSat };
    L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    const markers = L.markerClusterGroup();
    let chartInstance = null;
    let geojsonLayer = null;
    let allData = null;

    function updateMarkers(crop) {
        markers.clearLayers();
        if (geojsonLayer) map.removeLayer(geojsonLayer);

        const indiaBounds = L.latLngBounds([6.5, 68.0], [35.5, 97.5]);
        const filteredFeatures = allData.features.filter(feature => {
            const coords = feature.geometry.coordinates;
            const latlng = L.latLng(coords[1], coords[0]);
            return indiaBounds.contains(latlng) && feature.properties.name === crop;
        });

        const filteredGeoJSON = { type: "FeatureCollection", features: filteredFeatures };

        geojsonLayer = L.geoJSON(filteredGeoJSON, {
            pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                radius: 8, fillColor: "#ff7800", color: "#000",
                weight: 1, opacity: 1, fillOpacity: 0.8
            }),
            onEachFeature: function(feature, layer) {
                if (feature.properties && feature.properties.name) {
                    const d = feature.properties.data || {};
                    const popupContent = `<strong>${feature.properties.name}</strong><br>${d.createdAt ? `<em>${new Date(d.createdAt).toLocaleDateString('en-GB')}</em><br>` : ""}Consumer Buying Price: ${d.pricePerUnit || 'NA'}`;
                    layer.bindPopup(popupContent);
                }
            }
        });

        markers.addLayer(geojsonLayer);
        map.addLayer(markers);
        if (filteredFeatures.length > 0) map.fitBounds(markers.getBounds());
    }

    fetch("/consumers-geojson/")
        .then(res => res.json())
        .then(data => { allData = data; updateMarkers("onion"); })
        .catch(err => console.error("Error loading GeoJSON:", err));

    cropSelect.addEventListener("change", function() { updateMarkers(this.value); });
});

// const toggleBtn = document.getElementById("toggle-left-panel");
// const leftPanel = document.getElementById("map-controls");

// toggleBtn.addEventListener("click", () => {
//   leftPanel.classList.toggle("collapsed");
// });

const mapControls = document.getElementById('map-controls');
const toggleMapBtn = document.getElementById('toggle-map-controls');

toggleMapBtn.addEventListener('click', () => {
  mapControls.classList.toggle('collapsed');
});

</script>
{% endblock %}