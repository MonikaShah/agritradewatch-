{% extends 'syncapp/base.html' %}
{% load static %}

{% block title %}Consumers Map{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'syncapp/css/map.css' %}">
{% endblock %}

{% block content %}

<div id="map-container">
 <div id="map"></div>
  <div id="map-controls">
    <label for="commoditySelect"><b>Select Commodity</b></label>
    <select id="commoditySelect" class="form-control">
      {% for type, items in grouped_commodities.items %}
        <optgroup label="{{ type }}">
          {% for item in items %}
            <option value="{{ item.name }}" {% if item.disabled %}disabled{% endif %}>
              {{ item.name }}
            </option>
          {% endfor %}
        </optgroup>
      {% endfor %}
    </select>
        
    <hr>
    <div id="left-panel">
      <button id="locateBtn">üìç My Location</button>
      <label>Radius: <span id="radiusValue">100</span> m</label>
      <input type="range" id="radiusSlider" min="50" max="700" step="50" value="100" list="tickmarks">
      <datalist id="tickmarks">
        <option value="50" label="50m"></option>
        <option value="100" label="100m"></option>
        <option value="200" label="200m"></option>
        <option value="300" label="300m"></option>
        <option value="400" label="400m"></option>
        <option value="500" label="500m"></option>
        <option value="600" label="600m"></option>
        <option value="700" label="700m"></option>
      </datalist>
    </div>
  </div>
  <button id="toggle-map-controls">‚öôÔ∏è Hide/Show</button>
</div>

<div id="right-panel">
  <div class="box" id="graph-box">
    <h3>Consumer Reported Buying Price : <span id="selected-commodity"></span></h3>
    <div id="box1-consumer">
      Average Consumer Price: <span id="avg-price">--</span>
    </div>
    <canvas id="chartCanvas"></canvas>
  </div>

  <div class="box" id="farmer-box">
    <h3>Farmer Reported Selling Price</h3>
    <div id="farmer-info"></div>
  </div>

  <div class="box" id="agrowon-box">
    <h3>Agrowon Price</h3>
    <div id="agrowon-info">Click on a marker</div>
    <canvas id="agrowonBoxChart"></canvas>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function() {
    const commoditySelect = document.getElementById("commoditySelect");
    const selectedCommoditySpan = document.getElementById("selected-commodity");
    selectedCommoditySpan.innerText = commoditySelect.value;

    const map = L.map('map',{ zoomControl: false }).setView([19.2, 73.0], 7);

    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
    const googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { attribution: '&copy; Google' });
    googleSat.addTo(map);

    const baseMaps = { "OpenStreetMap": osm, "Google Satellite": googleSat };
    L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
    L.control.zoom({ position: 'topright' }).addTo(map);

    const markers = L.markerClusterGroup();
    let geojsonLayer = null;
    let allData = null;

    let userLocation = null;
    let userMarker = null;
    let radiusCircle = null;

    const radiusSlider = document.getElementById("radiusSlider");
    const radiusValue = document.getElementById("radiusValue");

    // üìç Get My Location
    document.getElementById("locateBtn").addEventListener("click", () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                userLocation = L.latLng(lat, lng);

                // Drop a draggable pin
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker(userLocation, { draggable: true, title: "My Location" }).addTo(map);

                // When marker is dragged, update location, circle and markers
                userMarker.on("dragend", function(e) {
                    userLocation = e.target.getLatLng();
                    drawCircle(parseInt(radiusSlider.value));
                    updateMarkers(commoditySelect.value, true); // zoom after drag
                });

                // Draw circle
                const radius = parseInt(radiusSlider.value);
                drawCircle(radius);

                // Refresh markers with radius coloring and zoom
                updateMarkers(commoditySelect.value, true);
            });
        } else {
            alert("Geolocation not supported by your browser.");
        }
    });

    // üéØ Draw circle function
    function drawCircle(radius) {
        if (radiusCircle) map.removeLayer(radiusCircle);
        radiusCircle = L.circle(userLocation, { radius: radius, color: "red", fillOpacity: 0.05 });
        radiusCircle.addTo(map);
    }

    // üéöÔ∏è Radius slider
    radiusSlider.addEventListener("input", function() {
        const radius = parseInt(this.value);
        radiusValue.textContent = radius;
        if (userLocation) {
            drawCircle(radius);
            updateMarkers(commoditySelect.value, false); // no zoom when just adjusting radius
        }
    });

    // üü¢üî¥ Update markers (inside green, outside red)
    function updateMarkers(commodity, zoomToBounds=false) {
        markers.clearLayers();
        if (geojsonLayer) map.removeLayer(geojsonLayer);

        const indiaBounds = L.latLngBounds([6.5, 68.0], [35.5, 97.5]);
        const filteredFeatures = allData.features.filter(feature => {
            const coords = feature.geometry.coordinates;
            const latlng = L.latLng(coords[1], coords[0]);
            return indiaBounds.contains(latlng) &&
                   feature.properties.name.toLowerCase() === commodity.toLowerCase();
        });

        const filteredGeoJSON = { type: "FeatureCollection", features: filteredFeatures };

        geojsonLayer = L.geoJSON(filteredGeoJSON, {
            pointToLayer: (feature, latlng) => {
                let markerColor = "red"; // default outside radius

                if (userLocation) {
                    const distance = userLocation.distanceTo(latlng);
                    const radius = parseInt(radiusSlider.value);
                    if (distance <= radius) {
                        markerColor = "green"; // inside radius
                    }
                }

                return L.circleMarker(latlng, {
                    radius: 8,
                    fillColor: markerColor,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                });
            },
            onEachFeature: function(feature, layer) {
                if (feature.properties && feature.properties.name) {
                    const p = feature.properties;
                    const popupContent = `
                        <strong>${p.name}</strong><br>
                        ${p.date ? `<em>${new Date(p.date).toLocaleDateString('en-GB')}</em><br>` : ""}
                        Consumer Buying Price: ${p.buyingprice || 'NA'}
                    `;
                    layer.bindPopup(popupContent);
                }
            }
        });

        markers.addLayer(geojsonLayer);
        map.addLayer(markers);

        // üìå Decide zoom target
        if (zoomToBounds && (filteredFeatures.length > 0 || userLocation)) {
            let bounds = markers.getBounds();

            if (userLocation) {
                bounds.extend(userLocation);
                if (radiusCircle) bounds.extend(radiusCircle.getBounds());
            }

            map.fitBounds(bounds, { padding: [30, 30] });
        }
    }

    // üì¶ Load data
    fetch("/api/consumers_geojson/")
      .then(res => res.json())
      .then(data => {
          allData = data;
          updateMarkers(commoditySelect.value, true); // default commodity with zoom
      })
      .catch(err => console.error("Error loading GeoJSON:", err));

    // ü•ï On commodity change ‚Üí update + zoom
    commoditySelect.addEventListener("change", function() { 
        selectedCommoditySpan.innerText = this.value;
        updateMarkers(this.value, true);
    });

    // ‚öôÔ∏è Toggle map controls
    const mapControls = document.getElementById('map-controls');
    const toggleMapBtn = document.getElementById('toggle-map-controls');
    toggleMapBtn.addEventListener('click', () => {
      mapControls.classList.toggle('collapsed');
    });
});
</script>
{% endblock %}
